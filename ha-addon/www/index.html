from flask import Flask, jsonify, request

app = Flask(__name__)

# --- GLOBAL DATA ---
users = [
    # { "unique_id": "u1", "user_name": "Mari" }
]

devices = [
    # { "unique_id": "d1", "custom_name": "ESP32 Hall", "user_id": "u1", "in_room": "r1" }
]

rooms = [
    # { "HA_register_room_id": "r1", "HA_register_room_name": "Eesruum" }
]

esp32_nodes = [
    # { "unique_id": "n1", "custom_name": "Node A", "room_id": "r1" }
]

# --- ROOMS ---
@app.route("/api/rooms", methods=["GET"])
def get_rooms():
    return jsonify(rooms)

@app.route("/api/rooms", methods=["POST"])
def add_room():
    data = request.json
    rooms.append({
        "HA_register_room_id": data["id"],
        "HA_register_room_name": data["name"]
    })
    return jsonify({"ok": True})

@app.route("/api/rooms/<room_id>", methods=["DELETE"])
def delete_room(room_id):
    global rooms
    rooms = [r for r in rooms if r["HA_register_room_id"] != room_id]
    return jsonify({"ok": True})

# --- USERS ---
@app.route("/api/users", methods=["GET"])
def get_users():
    return jsonify(users)

@app.route("/api/users", methods=["POST"])
def add_user():
    data = request.json
    users.append({
        "unique_id": data["id"],
        "user_name": data["name"]
    })
    return jsonify({"ok": True})

@app.route("/api/users/<user_id>", methods=["DELETE"])
def delete_user(user_id):
    global users
    users = [u for u in users if u["unique_id"] != user_id]
    return jsonify({"ok": True})

# --- DEVICES ---
@app.route("/api/devices", methods=["GET"])
def get_devices():
    return jsonify(devices)

@app.route("/api/devices", methods=["POST"])
def add_device():
    data = request.json
    devices.append({
        "unique_id": data["id"],
        "custom_name": data["name"],
        "user_id": data.get("user_id"),
        "in_room": data.get("in_room")
    })
    return jsonify({"ok": True})

@app.route("/api/devices/<device_id>", methods=["DELETE"])
def delete_device(device_id):
    global devices
    devices = [d for d in devices if d["unique_id"] != device_id]
    return jsonify({"ok": True})

# --- ESP32 NODES ---
@app.route("/api/nodes", methods=["GET"])
def get_nodes():
    return jsonify(esp32_nodes)

@app.route("/api/nodes", methods=["POST"])
def add_node():
    data = request.json
    esp32_nodes.append({
        "unique_id": data["id"],
        "custom_name": data["name"],
        "room_id": data.get("room_id")
    })
    return jsonify({"ok": True})

@app.route("/api/nodes/<node_id>", methods=["DELETE"])
def delete_node(node_id):
    global esp32_nodes
    esp32_nodes = [n for n in esp32_nodes if n["unique_id"] != node_id]
    return jsonify({"ok": True})


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
