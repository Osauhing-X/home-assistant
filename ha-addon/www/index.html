<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 BLE Addon</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    section { margin-bottom: 32px; }
    input, button { margin: 4px 0; }
    ul { padding-left: 18px; }
  </style>
</head>
<body>

<h1>ESP32 BLE Addon</h1>

<!-- ROOMS -->
<section>
  <h2>Ruumid</h2>
  <input id="room-name" placeholder="Ruum nimi" />
  <button onclick="addRoom()">Lisa</button>
  <ul id="rooms"></ul>
</section>

<!-- USERS -->
<section>
  <h2>Kasutajad</h2>
  <input id="user-name" placeholder="Kasutaja nimi" />
  <button onclick="addUser()">Lisa</button>
  <ul id="users"></ul>
</section>

<!-- DEVICES -->
<section>
  <h2>Seadmed</h2>
  <input id="device-name" placeholder="Seadme nimi" />
  <input id="device-user" placeholder="User ID" />
  <input id="device-room" placeholder="Room ID" />
  <button onclick="addDevice()">Lisa</button>
  <ul id="devices"></ul>
</section>

<!-- ESP32 -->
<section>
  <h2>ESP32 sõlmed</h2>
  <input id="node-name" placeholder="Node nimi" />
  <input id="node-room" placeholder="Room ID" />
  <button onclick="addNode()">Lisa</button>
  <ul id="nodes"></ul>
</section>

<script>
async function api(url, method = "GET", data) {
  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: data ? JSON.stringify(data) : undefined
  });
  return res.json();
}

/* ROOMS */
async function loadRooms() {
  const rooms = await api("/api/rooms");
  const ul = document.getElementById("rooms");
  ul.innerHTML = "";
  rooms.forEach(r => {
    ul.innerHTML += `<li>${r.HA_register_room_name} (${r.HA_register_room_id})</li>`;
  });
}
async function addRoom() {
  const name = document.getElementById("room-name").value;
  await api("/api/rooms", "POST", { name });
  loadRooms();
}

/* USERS */
async function loadUsers() {
  const users = await api("/api/users");
  const ul = document.getElementById("users");
  ul.innerHTML = "";
  users.forEach(u => {
    ul.innerHTML += `<li>${u.user_name} (${u.unique_id})</li>`;
  });
}
async function addUser() {
  const name = document.getElementById("user-name").value;
  await api("/api/users", "POST", { name });
  loadUsers();
}

/* DEVICES */
async function loadDevices() {
  const devices = await api("/api/devices");
  const ul = document.getElementById("devices");
  ul.innerHTML = "";
  devices.forEach(d => {
    ul.innerHTML += `<li>${d.custom_name} → user=${d.user_id}, room=${d.in_room}</li>`;
  });
}
async function addDevice() {
  await api("/api/devices", "POST", {
    name: device-name.value,
    user_id: device-user.value,
    room_id: device-room.value
  });
  loadDevices();
}

/* ESP32 */
async function loadNodes() {
  const nodes = await api("/api/esp32");
  const ul = document.getElementById("nodes");
  ul.innerHTML = "";
  nodes.forEach(n => {
    ul.innerHTML += `<li>${n.custom_name} → room=${n.room_id}</li>`;
  });
}
async function addNode() {
  await api("/api/esp32", "POST", {
    name: node-name.value,
    room_id: node-room.value
  });
  loadNodes();
}

loadRooms();
loadUsers();
loadDevices();
loadNodes();
</script>

</body>
</html>
