<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <title>ESP32 BLE Presence Management</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    ul { list-style: none; padding-left: 20px; }
    li { margin-bottom: 5px; }
    .node { margin-left: 20px; }
    .btn { margin-left: 5px; cursor: pointer; padding: 2px 5px; }
    .group { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
  </style>
</head>
<body>

<h1>ESP32 BLE Presence Management</h1>

<div class="group">
  <h2>Ruumid</h2>
  <ul id="roomsList"></ul>
  <button class="btn" onclick="addRoom()">+ Lisa ruum HA nimekirjast</button>
</div>

<div class="group">
  <h2>Inimesed</h2>
  <ul id="usersList"></ul>
  <button class="btn" onclick="addUser()">+ Lisa inimene HA nimekirjast</button>
</div>

<script>
async function fetchDevices() {
  const res = await fetch('/devices');
  return res.json();
}

async function fetchUsers() {
  const res = await fetch('/users');
  return res.json();
}

async function renderRooms() {
  const devices = await fetchDevices();
  const list = document.getElementById("roomsList");
  list.innerHTML = "";
  for (let id in devices) {
    const dev = devices[id];
    const li = document.createElement("li");
    li.textContent = `${dev.name} (${id})`;
    const btn = document.createElement("button");
    btn.textContent = "+ Lisa HA seade";
    btn.className = "btn";
    btn.onclick = () => alert(`Lisa HA seade ${dev.name}`);
    li.appendChild(btn);
    list.appendChild(li);
  }
}

async function renderUsers() {
  const users = await fetchUsers();
  const list = document.getElementById("usersList");
  list.innerHTML = "";
  for (let uname in users) {
    const user = users[uname];
    const li = document.createElement("li");
    li.textContent = uname;
    const subUl = document.createElement("ul");
    user.devices.forEach(dev => {
      const devLi = document.createElement("li");
      devLi.className = "node";
      devLi.textContent = `${dev.name} (${dev.id})`;
      const btnHa = document.createElement("button");
      btnHa.textContent = "+ Lisa HA seade";
      btnHa.className = "btn";
      btnHa.onclick = () => alert(`Lisa HA seade kasutajale ${uname}`);
      const btnLive = document.createElement("button");
      btnLive.textContent = "+ Lisa nähtav seade";
      btnLive.className = "btn";
      btnLive.onclick = () => alert(`Lisa nähtav seade kasutajale ${uname}`);
      devLi.appendChild(btnHa);
      devLi.appendChild(btnLive);
      subUl.appendChild(devLi);
    });
    li.appendChild(subUl);
    list.appendChild(li);
  }
}

function addRoom() {
  const roomName = prompt("Vali ruum HA nimekirjast:");
  if(roomName) alert(`Ruum lisatud: ${roomName} (placeholder)`);
}

function addUser() {
  const userName = prompt("Vali kasutaja HA nimekirjast või kirjuta uus:");
  if(userName) alert(`Kasutaja lisatud: ${userName} (placeholder)`);
}

// Init
renderRooms();
renderUsers();
</script>

</body>
</html>
