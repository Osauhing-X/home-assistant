<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>ESP32 BLE Presence Management</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h1,h2 { color: #333; }
.group { border: 1px solid #ccc; border-radius:8px; padding:15px; margin-bottom:20px; background:white; }
ul { list-style:none; padding-left:0; }
li { margin-bottom:5px; }
.node { margin-left:20px; }
.btn { margin-left:5px; cursor:pointer; padding:5px 8px; border-radius:4px; border:none; background:#1976d2; color:white; }
.btn:hover { background:#1565c0; }
</style>
</head>
<body>

<h1>ESP32 BLE Presence Management</h1>

<div class="group">
<h2>Ruumid</h2>
<ul id="roomsList"></ul>
<button class="btn" onclick="addRoom()">+ Lisa ruum</button>
</div>

<div class="group">
<h2>Kasutajad</h2>
<ul id="usersList"></ul>
<button class="btn" onclick="addUser()">+ Lisa kasutaja</button>
</div>

<script>
const API_BASE = window.location.origin + "/api";

async function fetchRooms() {
  const res = await fetch(`${API_BASE}/rooms`);
  return res.json();
}

async function fetchUsers() {
  const res = await fetch(`${API_BASE}/users`);
  return res.json();
}

async function fetchDevices() {
  const res = await fetch(`${API_BASE}/devices`);
  return res.json();
}

async function renderRooms() {
  const rooms = await fetchRooms();
  const list = document.getElementById("roomsList");
  list.innerHTML = "";
  rooms.forEach(r => {
    const li = document.createElement("li");
    li.textContent = `${r.HA_register_room_name} (${r.HA_register_room_id})`;
    list.appendChild(li);
  });
}

async function renderUsers() {
  const users = await fetchUsers();
  const devices = await fetchDevices();
  const list = document.getElementById("usersList");
  list.innerHTML = "";
  users.forEach(u => {
    const li = document.createElement("li");
    li.textContent = u.user_name;
    const subUl = document.createElement("ul");
    devices.filter(d => d.USER_ID === u.unique_id).forEach(d => {
      const devLi = document.createElement("li");
      devLi.className = "node";
      devLi.textContent = `${d.custom_name} (${d.unique_id})`;
      subUl.appendChild(devLi);
    });
    li.appendChild(subUl);
    list.appendChild(li);
  });
}

async function addRoom() {
  const name = prompt("Ruuminimi:");
  const id = prompt("Ruum ID:");
  if(name && id){
    await fetch(`${API_BASE}/rooms`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ HA_register_room_name:name, HA_register_room_id:id })
    });
    renderRooms();
  }
}

async function addUser() {
  const name = prompt("Kasutajanimi:");
  const id = prompt("Kasutaja ID:");
  if(name && id){
    await fetch(`${API_BASE}/users`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ user_name:name, unique_id:id })
    });
    renderUsers();
  }
}

// init
renderRooms();
renderUsers();
</script>

</body>
</html>
